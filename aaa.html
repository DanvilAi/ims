<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="A futuristic, AI voice-enabled arrival note form for seamless visitor registration.">
  <meta name="author" content="xAI Enhanced Design">
  <title>Visitor Arrival Note (AI Voice Enabled)</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Existing CSS remains unchanged */
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --secondary: #8b5cf6;
      --bg-dark: #0f172a;
      --bg-darker: #1e293b;
      --text-light: #f8fafc;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --accent: #ec4899;
      --light-mode-bg: #ffffff;
      --light-mode-text: #1e293b;
      --border-light: #e2e8f0;
      --border-dark: #334155;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      transition: background 0.3s ease;
      background-image: radial-gradient(circle at 25% 25%, rgba(37, 99, 235, 0.1) 0%, transparent 50%);
    }

    body.light-mode {
      background: var(--light-mode-bg);
      color: var(--light-mode-text);
      background-image: radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
    }

    .container {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 2.5rem;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
    }

    .light-mode .container {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .form-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .light-mode .form-header {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .form-title {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 0.5rem;
    }

    .form-subtitle {
      color: var(--text-light);
      opacity: 0.8;
      font-weight: 400;
      font-size: 1rem;
    }

    .light-mode .form-subtitle {
      color: var(--light-mode-text);
    }

    label {
      display: block;
      margin: 1.5rem 0 0.75rem;
      font-weight: 500;
      font-size: 0.95rem;
      color: var(--text-light);
      transition: color 0.3s ease;
    }

    .light-mode label {
      color: var(--light-mode-text);
    }

    .required-marker {
      color: var(--error);
      margin-left: 4px;
    }

    .input-group {
      position: relative;
      margin-bottom: 0.5rem;
    }

    input, textarea, select {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border-radius: 12px;
      border: 2px solid var(--border-dark);
      font-size: 1rem;
      background: rgba(15, 23, 42, 0.5);
      color: var(--text-light);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      outline: none;
    }

    .light-mode input,
    .light-mode textarea,
    .light-mode select {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid var(--border-light);
      color: var(--light-mode-text);
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.3);
      background: rgba(15, 23, 42, 0.8);
    }

    .light-mode input:focus,
    .light-mode textarea:focus,
    .light-mode select:focus {
      background: rgba(255, 255, 255, 0.95);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
      padding: 1rem;
    }

    .field-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 1.1rem;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .btn {
      padding: 0.6rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .btn-mic {
      background: var(--primary);
      color: white;
    }

    .btn-mic:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .btn-mic:active {
      transform: scale(0.98);
    }

    .btn-mic.recording {
      background: var(--error);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .btn-clear {
      background: var(--error);
      color: white;
      opacity: 0;
      pointer-events: none;
    }

    .input-group:focus-within .btn-clear,
    .input-group:hover .btn-clear {
      opacity: 1;
      pointer-events: auto;
    }

    .btn-clear:hover {
      background: #dc2626;
    }

    .progress-container {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin: 2rem 0;
      overflow: hidden;
    }

    .light-mode .progress-container {
      background: rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0;
      transition: width 0.5s ease;
    }

    .btn-submit {
      width: 100%;
      padding: 1rem;
      border-radius: 12px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-submit:active {
      transform: translateY(0);
    }

    .btn-submit.loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-message {
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }

    .status-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .success {
      color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }

    .error {
      color: var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .validation-message {
      font-size: 0.85rem;
      margin-top: 0.25rem;
      padding-left: 0.5rem;
      color: var(--error);
      height: 0;
      overflow: hidden;
      transition: height 0.3s ease;
    }

    .validation-message.show {
      height: 1.25rem;
    }

    .char-counter {
      font-size: 0.75rem;
      text-align: right;
      margin-top: 0.25rem;
      opacity: 0.6;
    }

    .privacy-notice {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 1.5rem;
      text-align: center;
      line-height: 1.5;
    }

    .light-mode .privacy-notice {
      opacity: 0.8;
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: none;
      color: var(--text-light);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .light-mode .theme-toggle {
      background: rgba(255, 255, 255, 0.8);
      color: var(--light-mode-text);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .theme-toggle:hover {
      transform: rotate(30deg) scale(1.1);
    }

    .theme-toggle:active {
      transform: rotate(30deg) scale(0.95);
    }

    .verification-check {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .light-mode .verification-check {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .verification-title {
      font-size: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
    }

    .light-mode .verification-title {
      color: var(--light-mode-text);
    }

    .verification-result {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }

    .verification-result.verified {
      display: block;
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .verification-result.not-verified {
      display: block;
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .verification-result.pending {
      display: block;
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .topic-list {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0 0;
    }

    .topic-item {
      margin: 0.5rem 0;
      padding: 0.5rem;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .topic-item a {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
    }

    .topic-item a:hover {
      text-decoration: underline;
    }

    .study-advice {
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: rgba(37, 99, 235, 0.1);
      border-radius: 6px;
      font-size: 0.85rem;
      display: none;
    }

    .study-advice.show {
      display: block;
    }

    .place-field {
      margin-top: 1.5rem;
    }

    @media (max-width: 640px) {
      .container {
        padding: 1.5rem;
        max-width: 95%;
      }
      
      .form-title {
        font-size: 1.6rem;
      }

      .theme-toggle {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
      }

      input, textarea, select {
        padding: 0.9rem 0.9rem 0.9rem 2.8rem;
      }

      .verification-check {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">
    <i class="fas fa-moon"></i>
  </button>
  
  <div class="container">
    <div class="form-header">
      <h1 class="form-title">IMS  <i class="fas fa-id-badge"></i></h1>
      <p class="form-subtitle">Please complete this form to register your arrival</p>
    </div>

    <!-- Verification Check Section -->
    <div class="verification-check">
      <h3 class="verification-title">
        <i class="fas fa-search"></i> Check Verification Status
      </h3>
      <div class="input-group">
        <i class="fas fa-id-card field-icon"></i>
        <input type="text" id="verificationId" placeholder="Enter your ID number to check status" />
        <div class="action-buttons">
          <button type="button" class="btn btn-clear" onclick="clearField('verificationId')" aria-label="Clear field">
            <i class="fas fa-times"></i>
          </button>

        </div>
      </div>
      <button type="button" class="btn-submit" id="checkVerificationBtn" style="margin-top: 1rem;">
        <i class="fas fa-check-circle"></i> Check Status
      </button>
      <div class="verification-result" id="verificationResult"></div>
    </div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="arrivalForm">
      <!-- Name Field -->
      <label for="name">
        <i class="fas fa-user"></i> Full Name <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="fas fa-user field-icon"></i>
        <input type="text" id="name" placeholder="LAMECK" maxlength="50" aria-required="true" />
        <div class="action-buttons">
          <button type="button" class="btn btn-clear" onclick="clearField('name')" aria-label="Clear field">
            <i class="fas fa-times"></i>
          </button>

        </div>
      </div>
      <div class="validation-message" id="name-validation"></div>
      <div class="char-counter"><span id="name-counter">0</span>/50</div>

      <!-- ID Field -->
      <label for="id">
        <i class="fas fa-id-card"></i> ID / Registration Number <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="fas fa-id-card field-icon"></i>
        <input type="text" id="id" placeholder="ABC12345" maxlength="20" aria-required="true" />
        <div class="action-buttons">
          <button type="button" class="btn btn-clear" onclick="clearField('id')" aria-label="Clear field">
            <i class="fas fa-times"></i>
          </button>

        </div>
      </div>
      <div class="validation-message" id="id-validation"></div>
      <div class="char-counter"><span id="id-counter">0</span>/20</div>

      <!-- Supervisor Field -->
      <label for="supervisor">
        <i class="fas fa-user-tie"></i> Supervisor Name <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="fas fa-user-tie field-icon"></i>
        <input type="text" id="supervisor" placeholder="Dr.lameck" maxlength="50" aria-required="true" />
        <div class="action-buttons">
          <button type="button" class="btn btn-clear" onclick="clearField('supervisor')" aria-label="Clear field">
            <i class="fas fa-times"></i>
          </button>

          </button>
        </div>
      </div>
      <div class="validation-message" id="supervisor-validation"></div>
      <div class="char-counter"><span id="supervisor-counter">0</span>/50</div>

      <!-- Phone Field -->
      <label for="phone">
        <i class="fas fa-phone"></i> Supervisor Phone <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="fas fa-phone field-icon"></i>
        <input type="tel" id="phone" placeholder="0621658007" aria-required="true" />
        <div class="action-buttons">
          <button type="button" class="btn btn-clear" onclick="clearField('phone')" aria-label="Clear field">
            <i class="fas fa-times"></i>
          </button>
          
        </div>
      </div>
      <div class="validation-message" id="phone-validation"></div>

      <!-- Date Field -->
      <label for="date">
        <i class="far fa-calendar-alt"></i> Arrival Date <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="far fa-calendar-alt field-icon"></i>
        <input type="date" id="date" aria-required="true" />
      </div>
      <div class="validation-message" id="date-validation"></div>

      <!-- Time Field -->
      <label for="time">
        <i class="far fa-clock"></i> Arrival Time <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="far fa-clock field-icon"></i>
        <input type="time" id="time" aria-required="true" />
      </div>
      <div class="validation-message" id="time-validation"></div>

      <!-- Place/Destination Field -->
      <label for="place">
        <i class="fas fa-map-marker-alt"></i> Place/Location <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="fas fa-map-marker-alt field-icon"></i>
        <input type="text" id="place" placeholder="Mwanza city council" maxlength="100" aria-required="true" />
        <div class="action-buttons">
          <button type="button" class="btn btn-clear" onclick="clearField('place')" aria-label="Clear field">
            <i class="fas fa-times"></i>
          </button>

        </div>
      </div>
      <div class="validation-message" id="place-validation"></div>
      <div class="char-counter"><span id="place-counter">0</span>/100</div>

      <!-- Purpose Field -->
      <label for="purpose">
        <i class="fas fa-bullseye"></i> Purpose of Visit <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="fas fa-bullseye field-icon"></i>
        <select id="purpose" aria-required="true">
          <option value="" disabled selected>Select purpose</option>
          <option value="Meeting">Meeting</option>
          <option value="Delivery">Delivery</option>
          <option value="Interview">Interview</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Training">Training</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="validation-message" id="purpose-validation"></div>

      <!-- Department Field -->
      <label for="department">
        <i class="fas fa-building"></i> Department / Destination <span class="required-marker">*</span>
      </label>
      <div class="input-group">
        <i class="fas fa-building field-icon"></i>
        <select id="department" aria-required="true">
          <option value="" disabled selected>Select department</option>
          <option value="HR">Human Resources</option>
          <option value="Finance">Finance</option>
          <option value="IT">Information Technology</option>
          <option value="Operations">Operations</option>
          <option value="Marketing">Marketing</option>
          <option value="Executive">Executive Office</option>
        </select>
      </div>
      <div class="validation-message" id="department-validation"></div>

      <!-- Comments Field -->
      <label for="comments">
        <i class="fas fa-info-circle"></i> Additional notes
      </label>
      <div class="input-group">
        <textarea id="comments" placeholder="Optional notes..." maxlength="200"></textarea>

      </div>
      <div class="char-counter"><span id="comments-counter">0</span>/200</div>

      <!-- Submit Button -->
      <button type="submit" class="btn-submit" id="submitBtn">
        <i class="fas fa-arrow-circle-right"></i>
        Submit Arrival Note
      </button>

      <div class="privacy-notice">
        <i class="fas fa-lock"></i> Your information is secure and will only be used for visitor management purposes. 
        By submitting this form, you agree to our data processing policy.
      </div>
    </form>

    <!-- Status Messages -->
    <div class="status-message success" id="successMessage">
      <i class="fas fa-check-circle"></i> Form submitted successfully!
    </div>
    <div class="status-message error" id="errorMessage">
      <i class="fas fa-exclamation-circle"></i> Please fill all required fields.
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA5lyEP6r5sgMOeFxHz_tVsSk9c1nNXUkY",
      authDomain: "penguinpixel-cfaf2.firebaseapp.com",
      projectId: "penguinpixel-cfaf2",
      storageBucket: "penguinpixel-cfaf2.appspot.com",
      messagingSenderId: "161642251943",
      appId: "1:161642251943:web:6c99e93270c3900379fd82",
      measurementId: "G-8DTF1BQ4HN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Gemini API configuration
    const GEMINI_API_KEY = 'AIzaSyD-WJmxHIkKApO6RPi-_y9kjIF-CkbIqCw';
    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

    // DOM Elements
    const form = document.getElementById("arrivalForm");
    const successMessage = document.getElementById("successMessage");
    const errorMessage = document.getElementById("errorMessage");
    const submitBtn = document.getElementById("submitBtn");
    const progressBar = document.getElementById("progressBar");
    const themeToggle = document.querySelector('.theme-toggle i');
    const checkVerificationBtn = document.getElementById("checkVerificationBtn");
    const verificationResult = document.getElementById("verificationResult");

    // Theme Toggle
    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      themeToggle.classList.toggle('fa-moon');
      themeToggle.classList.toggle('fa-sun');
      localStorage.setItem('lightMode', document.body.classList.contains('light-mode'));
    }

    // Check for saved theme preference
    if (localStorage.getItem('lightMode') === 'true') {
      document.body.classList.add('light-mode');
      themeToggle.classList.remove('fa-moon');
      themeToggle.classList.add('fa-sun');
    }

    // Field Clearing Function
    function clearField(fieldId) {
      const field = document.getElementById(fieldId);
      field.value = '';
      field.focus();
      validateField(fieldId);
      updateProgress();
      updateCharCounter(fieldId);
    }

    // Character Counting
    function updateCharCounter(fieldId) {
      const counterElement = document.getElementById(`${fieldId}-counter`);
      if (counterElement) {
        const field = document.getElementById(fieldId);
        counterElement.textContent = field.value.length;
      }
    }

    // Initialize character counters
    document.querySelectorAll('input[maxlength], textarea[maxlength]').forEach(field => {
      field.addEventListener('input', () => updateCharCounter(field.id));
      updateCharCounter(field.id);
    });

    // Voice Input
    function startVoice(fieldId) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showStatusMessage("Your browser does not support speech recognition.", 'error');
        return;
      }

      const micBtn = document.getElementById(`mic-${fieldId}`);
      micBtn.classList.add('recording');
      
      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      
      recognition.start();

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        const field = document.getElementById(fieldId);
        
        if (field.tagName === 'SELECT') {
          const options = Array.from(field.options);
          const matchedOption = options.find(opt => 
            opt.text.toLowerCase().includes(transcript.toLowerCase())
          );
          if (matchedOption) field.value = matchedOption.value;
        } else {
          field.value = transcript;
        }
        
        validateField(fieldId);
        updateProgress();
        updateCharCounter(fieldId);
        micBtn.classList.remove('recording');
      };

      recognition.onerror = function(event) {
        showStatusMessage("Voice input error: " + event.error, 'error');
        micBtn.classList.remove('recording');
      };
      
      recognition.onspeechend = function() {
        recognition.stop();
        micBtn.classList.remove('recording');
      };
    }

    // Field Validation
    function validateField(fieldId) {
      const field = document.getElementById(fieldId);
      const validationElement = document.getElementById(`${fieldId}-validation`);
      
      if (!field.hasAttribute('aria-required')) return true;
      
      let isValid = true;
      let message = '';
      
      if (!field.value.trim()) {
        isValid = false;
        message = 'This field is required';
      } else if (fieldId === 'phone' && !/^[\d\s\(\)\+\-]+$/.test(field.value)) {
        isValid = false;
        message = 'Please enter a valid phone number';
      } else if (fieldId === 'place' && field.value.trim().length < 3) {
        isValid = false;
        message = 'Please enter a valid place/destination';
      }
      
      if (validationElement) {
        validationElement.textContent = message;
        validationElement.classList.toggle('show', !isValid);
      }
      
      return isValid;
    }

    // Form Validation
    function isFormValid() {
      const requiredFields = ['name', 'id', 'supervisor', 'phone', 'date', 'time', 'purpose', 'department', 'place'];
      return requiredFields.every(fieldId => validateField(fieldId));
    }

    // Progress Tracking
    function updateProgress() {
      const requiredFields = ['name', 'id', 'supervisor', 'phone', 'date', 'time', 'purpose', 'department', 'place'];
      let filled = requiredFields.reduce((count, fieldId) => {
        const field = document.getElementById(fieldId);
        return field.value.trim() ? count + 1 : count;
      }, 0);
      
      const progress = (filled / requiredFields.length) * 100;
      progressBar.style.width = `${progress}%`;
    }

    // Status Messages
    function showStatusMessage(message, type = 'success') {
      const element = type === 'success' ? successMessage : errorMessage;
      element.textContent = message;
      element.classList.add('show');
      setTimeout(() => element.classList.remove('show'), 5000);
    }

    // Gemini API Call for Study Suggestions
    async function getStudySuggestions(department) {
      try {
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `Suggest 4 topics or skills to study for someone visiting the ${department} department.`
              }]
            }]
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const suggestions = data.candidates[0].content.parts[0].text
          .split('\n')
          .filter(t => t.trim())
          .map(t => t.replace(/^\d+\.\s*|\*\*\s*|\*\s*/g, '').trim())
          .slice(0, 4);

        return { suggestions };
      } catch (error) {
        console.error('Gemini API error:', error);
        const departmentSuggestions = {
          'HR': ['Employee Engagement Strategies', 'Labor Laws and Regulations', 'Recruitment Best Practices', 'Conflict Resolution Techniques'],
          'Finance': ['Financial Analysis', 'Budgeting and Forecasting', 'Accounting Principles', 'Investment Strategies'],
          'IT': ['Cybersecurity Fundamentals', 'Cloud Computing', 'Network Administration', 'Programming Basics'],
          'Operations': ['Supply Chain Management', 'Process Optimization', 'Lean Six Sigma', 'Project Management'],
          'Marketing': ['Digital Marketing Trends', 'SEO and SEM', 'Consumer Behavior', 'Brand Management'],
          'Executive': ['Strategic Planning', 'Leadership Development', 'Corporate Governance', 'Decision-Making Frameworks']
        };
        return { suggestions: departmentSuggestions[department] || ['General Business Acumen', 'Communication Skills', 'Time Management'] };
      }
    }

    // Gemini API Call for Study Advice
    async function getStudyAdvice(topic) {
      try {
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `Provide detailed advice on how to study and understand ${topic}. Include specific strategies, resources, and practical steps to master the topic effectively. Keep the response concise and practical, within 200 words.`
              }]
            }]
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
      } catch (error) {
        console.error('Gemini API error for study advice:', error);
        return `To study ${topic}, start with reputable online courses (e.g., Coursera, Udemy) or books from established authors. Break the topic into subtopics, create a study schedule, and use active learning techniques like summarizing, teaching others, or applying concepts to real-world scenarios. Practice regularly and seek feedback.`;
      }
    }

    // Handle Topic Click
    async function handleTopicClick(topic, adviceElementId) {
      const adviceElement = document.getElementById(adviceElementId);
      adviceElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading study advice...';
      adviceElement.classList.add('show');
      
      const advice = await getStudyAdvice(topic);
      adviceElement.innerHTML = advice;
      adviceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Verification Status Check
    checkVerificationBtn.addEventListener('click', async function() {
      const verificationId = document.getElementById('verificationId').value.trim();
      
      if (!verificationId) {
        verificationResult.textContent = "Please enter an ID number to check";
        verificationResult.className = "verification-result not-verified";
        return;
      }
      
      checkVerificationBtn.disabled = true;
      checkVerificationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
      
      try {
        const q = query(collection(db, "arrivalNotes"), where("id", "==", verificationId));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const docData = querySnapshot.docs[0].data();
          const visitDate = new Date(docData.date).toLocaleDateString();
          
          if (docData.approved) {
            const suggestions = await getStudySuggestions(docData.department);
            verificationResult.innerHTML = `
              <i class="fas fa-check-circle"></i> Verified and Approved<br>
              <small>Name: ${docData.name}</small><br>
              <small>Last visit: ${visitDate}</small><br>
              <small>Department: ${docData.department}</small><br>
              <strong>Recommended Study Topics:</strong><br>
              <ul class="topic-list">
                ${suggestions.suggestions.map((topic, index) => `
                  <li class="topic-item">
                    <a onclick="handleTopicClick('${topic}', 'advice-${index}')">${topic}</a>
                    <div class="study-advice" id="advice-${index}"></div>
                  </li>
                `).join('')}
              </ul>
            `;
            verificationResult.className = "verification-result verified";
          } else {
            verificationResult.innerHTML = `
              <i class="fas fa-exclamation-circle"></i> Pending Approval<br>
              <small>Name: ${docData.name}</small><br>
              <small>Last visit: ${visitDate}</small><br>
              <small>Your visit is awaiting admin approval. Please check back later.</small>
            `;
            verificationResult.className = "verification-result pending";
          }
        } else {
          verificationResult.innerHTML = '<i class="fas fa-times-circle"></i> No records found for this ID';
          verificationResult.className = "verification-result not-verified";
        }
      } catch (error) {
        console.error("Error checking verification:", error);
        verificationResult.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error checking status';
        verificationResult.className = "verification-result not-verified";
      } finally {
        checkVerificationBtn.disabled = false;
        checkVerificationBtn.innerHTML = '<i class="fas fa-check-circle"></i> Check Status';
      }
    });

    // Expose handleTopicClick to global scope for onclick
    window.handleTopicClick = handleTopicClick;

    // Form Submission
    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      
      if (isFormValid()) {
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;

        try {
          const formData = {
            name: document.getElementById('name').value,
            id: document.getElementById('id').value,
            supervisor: document.getElementById('supervisor').value,
            phone: document.getElementById('phone').value,
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            purpose: document.getElementById('purpose').value,
            department: document.getElementById('department').value,
            place: document.getElementById('place').value,
            comments: document.getElementById('comments').value,
            approved: false,
            timestamp: new Date(),
            userAgent: navigator.userAgent,
            screenResolution: `${window.screen.width}x${window.screen.height}`
          };

          const docRef = await addDoc(collection(db, "arrivalNotes"), formData);
          console.log("Document written with ID: ", docRef.id);

          showStatusMessage("Arrival note submitted successfully! Awaiting admin approval.", 'success');
          
          setTimeout(() => {
            form.reset();
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            progressBar.style.width = "0%";
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            document.getElementById('date').value = dateStr;
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('time').value = `${hours}:${minutes}`;
            
            ['name', 'id', 'supervisor', 'comments', 'place'].forEach(fieldId => {
              updateCharCounter(fieldId);
            });
          }, 3000);
        } catch (error) {
          console.error("Error adding document: ", error);
          showStatusMessage("Error submitting form. Please try again.", 'error');
          submitBtn.classList.remove('loading');
          submitBtn.disabled = false;
        }
      } else {
        showStatusMessage("Please fill all required fields correctly.", 'error');
        const firstErrorField = document.querySelector('.validation-message.show');
        if (firstErrorField) {
          firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    });

    // Initialize form with current date/time
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      document.getElementById('date').value = dateStr;
      
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('time').value = `${hours}:${minutes}`;
      
      document.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('blur', () => validateField(field.id));
        field.addEventListener('input', () => {
          validateField(field.id);
          updateProgress();
        });
      });
      
      updateProgress();
    });

    // Keyboard Accessibility
    document.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          btn.click();
        }
      });
    });

    // Auto-format phone number
    document.getElementById('phone').addEventListener('input', function(e) {
      const x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
      e.target.value = !x[2] ? x[1] : `(${x[1]}) ${x[2]}${x[3] ? `-${x[3]}` : ''}`;
    });
  </script>
</body>
</html>